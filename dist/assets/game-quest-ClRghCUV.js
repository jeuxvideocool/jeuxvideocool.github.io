import{d as L,c as C,w as M,r as w,e as P}from"./loaders-CNHm-dlv.js";import{c as R,a as G}from"./input-xiSeUQqn.js";import{c as B}from"./loop-24SuRqx9.js";import{a as D,c as u,d as U}from"./index-niTdxgfr.js";const d="quest",t=L(d),T=C(),l=T.find(r=>r.id===(t==null?void 0:t.themeId))||T[0];D();const x=new Image;x.src=new URL("data:image/svg+xml,%3csvg%20width='140'%20height='160'%20viewBox='0%200%20140%20160'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3clinearGradient%20id='cloak'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%237CFFE1'/%3e%3cstop%20offset='1'%20stop-color='%237B8CFF'/%3e%3c/linearGradient%3e%3c/defs%3e%3cpath%20d='M70%2014c18%200%2032%2014%2032%2032v16l10%2016-10%2010v30c0%2010-8%2018-18%2018H56c-10%200-18-8-18-18v-30l-10-10%2010-16V46c0-18%2014-32%2032-32Z'%20fill='url(%23cloak)'%20stroke='%230AF0FF'%20stroke-width='4'/%3e%3ccircle%20cx='70'%20cy='54'%20r='18'%20fill='%230A0F1F'%20stroke='%23E9F5FF'%20stroke-width='4'/%3e%3crect%20x='54'%20y='96'%20width='32'%20height='36'%20rx='12'%20fill='%230A0F1F'%20opacity='0.8'/%3e%3ccircle%20cx='60'%20cy='52'%20r='5'%20fill='%23E9F5FF'/%3e%3ccircle%20cx='80'%20cy='52'%20r='5'%20fill='%23E9F5FF'/%3e%3c/svg%3e",import.meta.url).href;const v=new Image;v.src=new URL("data:image/svg+xml,%3csvg%20width='80'%20height='80'%20viewBox='0%200%2080%2080'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3cradialGradient%20id='orb'%20cx='0'%20cy='0'%20r='1'%20gradientUnits='userSpaceOnUse'%20gradientTransform='translate(40%2040)%20scale(38)'%3e%3cstop%20stop-color='%237B8CFF'/%3e%3cstop%20offset='1'%20stop-color='%230A0F24'/%3e%3c/radialGradient%3e%3c/defs%3e%3ccircle%20cx='40'%20cy='40'%20r='34'%20fill='url(%23orb)'%20stroke='%23B6C4FF'%20stroke-width='4'/%3e%3ccircle%20cx='40'%20cy='34'%20r='12'%20fill='%23E9F5FF'%20fill-opacity='0.75'/%3e%3c/svg%3e",import.meta.url).href;const F=new Image;F.src=new URL("data:image/svg+xml,%3csvg%20width='90'%20height='70'%20viewBox='0%200%2090%2070'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='6'%20y='28'%20width='78'%20height='20'%20rx='6'%20fill='%232D0A12'%20stroke='%23FF5F6D'%20stroke-width='4'/%3e%3cpath%20d='M10%2048%2018%2022l10%2026%2010-26%2010%2026%2010-26%2010%2026%2010-26%206%2026'%20stroke='%23FFB6BF'%20stroke-width='4'%20stroke-linecap='round'/%3e%3c/svg%3e",import.meta.url).href;const E=new Image;E.src=new URL("data:image/svg+xml,%3csvg%20width='90'%20height='140'%20viewBox='0%200%2090%20140'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='18'%20y='8'%20width='54'%20height='124'%20rx='10'%20fill='%230A0F1F'%20stroke='%237CFFE1'%20stroke-width='4'/%3e%3crect%20x='26'%20y='16'%20width='38'%20height='108'%20rx='8'%20fill='%230A162E'%20stroke='%2300D9F5'%20stroke-width='3'/%3e%3ccircle%20cx='45'%20cy='70'%20r='10'%20fill='%2300F5A0'/%3e%3c/svg%3e",import.meta.url).href;if(l){const r=document.documentElement.style;r.setProperty("--color-primary",l.colors.primary),r.setProperty("--color-secondary",l.colors.secondary),r.setProperty("--color-accent",l.colors.accent),r.setProperty("--color-text",l.colors.text),r.setProperty("--color-muted",l.colors.muted),document.body.style.background=l.gradient||document.body.style.background}const m=document.getElementById("game-canvas"),f=document.getElementById("ui"),i=m.getContext("2d"),g=R(),p=document.createElement("div");p.className="overlay";p.style.display="none";f.appendChild(p);const c={up:(t==null?void 0:t.input.keys.up)||"ArrowUp",down:(t==null?void 0:t.input.keys.down)||"ArrowDown",left:(t==null?void 0:t.input.keys.left)||"ArrowLeft",right:(t==null?void 0:t.input.keys.right)||"ArrowRight"};G({container:document.body,input:g,mapping:{up:c.up,down:c.down,left:c.left,right:c.right}});const e={running:!1,width:0,height:0,player:{x:0,y:0,r:12},items:[],traps:[],gate:{x:0,y:0,open:!1},timer:(t==null?void 0:t.difficultyParams.timeLimitSeconds)??60,collected:0};function A(){m.width=window.innerWidth*devicePixelRatio,m.height=window.innerHeight*devicePixelRatio,e.width=m.width/devicePixelRatio,e.height=m.height/devicePixelRatio}A();window.addEventListener("resize",A);const S=B({update:r=>_(r),render:q,fps:60});function H(){if(!t){b("Config manquante","Ajoute configs/games/quest.config.json",!1);return}e.running=!0,e.player.x=e.width*.15,e.player.y=e.height/2,e.items=[],e.traps=[],e.collected=0,e.gate={x:e.width*.85,y:e.height/2,open:!1},e.timer=t.difficultyParams.timeLimitSeconds,O(),$(),p.style.display="none",u({type:"SESSION_START",gameId:d}),S.start()}function O(){for(let r=0;r<((t==null?void 0:t.difficultyParams.itemCount)??6);r++)e.items.push({x:w(e.width*.25,e.width*.8),y:w(50,e.height-50),collected:!1})}function $(){for(let r=0;r<((t==null?void 0:t.difficultyParams.trapCount)??4);r++)e.traps.push({x:w(e.width*.2,e.width*.8),y:w(60,e.height-60),active:!0})}function k(r){e.running=!1,S.stop(),u({type:r?"QUEST_COMPLETE":"SESSION_FAIL",gameId:d,payload:{remaining:e.timer}}),U(d,(t==null?void 0:t.saveSchemaVersion)??1,n=>{const o=n.state.bestTime||0;r&&e.timer>o&&(n.state.bestTime=e.timer,n.bestScore=e.timer)}),b(r?"Porte franchie":"Temps écoulé",(t==null?void 0:t.uiText.help)||"")}function b(r,a,n=!0){p.style.display="grid",p.innerHTML=`
    <div class="panel">
      <p class="pill">Mini Quest</p>
      <h2>${r}</h2>
      <p>${a}</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        ${n?'<button class="btn" id="play-btn">Lancer</button>':""}
        <a class="btn secondary" href="${M("/apps/hub/")}">Hub</a>
      </div>
    </div>
  `;const o=document.getElementById("play-btn");o==null||o.addEventListener("click",H)}b((t==null?void 0:t.uiText.title)||"Mini Quest",(t==null?void 0:t.uiText.help)||"");function _(r){if(!e.running||!t)return;if(e.timer-=r,e.timer<=0){k(!1);return}const a=(g.isDown(c.right)?1:0)+(g.isDown(c.left)?-1:0),n=(g.isDown(c.down)?1:0)+(g.isDown(c.up)?-1:0);e.player.x+=a*t.difficultyParams.playerSpeed*(r*60),e.player.y+=n*t.difficultyParams.playerSpeed*(r*60),e.player.x=P(e.player.x,e.player.r,e.width-e.player.r),e.player.y=P(e.player.y,e.player.r,e.height-e.player.r),e.items.forEach(s=>{if(s.collected)return;const y=s.x-e.player.x,h=s.y-e.player.y;Math.sqrt(y*y+h*h)<e.player.r+10&&(s.collected=!0,e.collected+=1,u({type:"ITEM_COLLECTED",gameId:d}),e.collected>=e.items.length&&(e.gate.open=!0,u({type:"GATE_UNLOCKED",gameId:d})))}),e.traps.forEach(s=>{if(!s.active)return;const y=s.x-e.player.x,h=s.y-e.player.y;Math.sqrt(y*y+h*h)<e.player.r+10&&(s.active=!1,e.timer=Math.max(0,e.timer-5),u({type:"TRAP_TRIGGERED",gameId:d}))});const o=e.gate.x-e.player.x,I=e.gate.y-e.player.y;e.gate.open&&Math.sqrt(o*o+I*I)<e.player.r+16&&k(!0)}function q(){i.save(),i.scale(devicePixelRatio,devicePixelRatio),i.clearRect(0,0,e.width,e.height),E.complete?(i.globalAlpha=e.gate.open?1:.65,i.drawImage(E,e.gate.x-20,e.gate.y-50,40,100),i.globalAlpha=1):(i.fillStyle=e.gate.open?l.colors.accent:"rgba(255,255,255,0.1)",i.fillRect(e.gate.x-14,e.gate.y-24,28,48)),e.items.forEach(a=>{a.collected&&(i.globalAlpha=.35),v.complete?i.drawImage(v,a.x-16,a.y-16,32,32):(i.fillStyle=a.collected?"rgba(255,255,255,0.2)":l.colors.secondary,i.beginPath(),i.arc(a.x,a.y,10,0,Math.PI*2),i.fill()),i.globalAlpha=1}),e.traps.forEach(a=>{a.active&&(F.complete?i.drawImage(F,a.x-22,a.y-16,44,32):(i.fillStyle="rgba(255,95,109,0.9)",i.beginPath(),i.moveTo(a.x,a.y-10),i.lineTo(a.x-10,a.y+10),i.lineTo(a.x+10,a.y+10),i.closePath(),i.fill()))});const r=e.player.r*2.6;x.complete?i.drawImage(x,e.player.x-r/2,e.player.y-r/2,r,r):(i.fillStyle=l.colors.primary,i.beginPath(),i.arc(e.player.x,e.player.y,e.player.r,0,Math.PI*2),i.fill()),i.restore(),N()}function N(){f.innerHTML="",f.appendChild(p);const r=document.createElement("div");r.className="hud",r.innerHTML=`
    <div class="pill">Temps ${e.timer.toFixed(1)}s</div>
    <div class="pill">Objets ${e.collected}/${e.items.length}</div>
    <div class="pill">Porte ${e.gate.open?"ouverte":"fermée"}</div>
  `,f.appendChild(r)}
