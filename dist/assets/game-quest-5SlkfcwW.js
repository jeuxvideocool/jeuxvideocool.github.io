import{d as S,c as L,w as M,r as g,e as P}from"./loaders-CNHm-dlv.js";import{c as C,a as R}from"./input-BV31AzWF.js";import{c as G}from"./loop-24SuRqx9.js";import{a as A,c as h,d as D}from"./index-niTdxgfr.js";const c="quest",a=S(c),b=L(),i=b.find(t=>t.id===(a==null?void 0:a.themeId))||b[0];A();if(i){const t=document.documentElement.style;t.setProperty("--color-primary",i.colors.primary),t.setProperty("--color-secondary",i.colors.secondary),t.setProperty("--color-accent",i.colors.accent),t.setProperty("--color-text",i.colors.text),t.setProperty("--color-muted",i.colors.muted),document.body.style.background=i.gradient||document.body.style.background}const m=document.getElementById("game-canvas"),x=document.getElementById("ui"),r=m.getContext("2d"),u=C(),d=document.createElement("div");d.className="overlay";d.style.display="none";x.appendChild(d);const n={up:(a==null?void 0:a.input.keys.up)||"ArrowUp",down:(a==null?void 0:a.input.keys.down)||"ArrowDown",left:(a==null?void 0:a.input.keys.left)||"ArrowLeft",right:(a==null?void 0:a.input.keys.right)||"ArrowRight"};R({container:document.body,input:u,mapping:{up:n.up,down:n.down,left:n.left,right:n.right}});const e={running:!1,width:0,height:0,player:{x:0,y:0,r:12},items:[],traps:[],gate:{x:0,y:0,open:!1},timer:(a==null?void 0:a.difficultyParams.timeLimitSeconds)??60,collected:0};function T(){m.width=window.innerWidth*devicePixelRatio,m.height=window.innerHeight*devicePixelRatio,e.width=m.width/devicePixelRatio,e.height=m.height/devicePixelRatio}T();window.addEventListener("resize",T);const I=G({update:t=>O(t),render:_,fps:60});function $(){if(!a){v("Config manquante","Ajoute configs/games/quest.config.json",!1);return}e.running=!0,e.player.x=e.width*.15,e.player.y=e.height/2,e.items=[],e.traps=[],e.collected=0,e.gate={x:e.width*.85,y:e.height/2,open:!1},e.timer=a.difficultyParams.timeLimitSeconds,k(),H(),d.style.display="none",h({type:"SESSION_START",gameId:c}),I.start()}function k(){for(let t=0;t<((a==null?void 0:a.difficultyParams.itemCount)??6);t++)e.items.push({x:g(e.width*.25,e.width*.8),y:g(50,e.height-50),collected:!1})}function H(){for(let t=0;t<((a==null?void 0:a.difficultyParams.trapCount)??4);t++)e.traps.push({x:g(e.width*.2,e.width*.8),y:g(60,e.height-60),active:!0})}function E(t){e.running=!1,I.stop(),h({type:t?"QUEST_COMPLETE":"SESSION_FAIL",gameId:c,payload:{remaining:e.timer}}),D(c,(a==null?void 0:a.saveSchemaVersion)??1,o=>{const l=o.state.bestTime||0;t&&e.timer>l&&(o.state.bestTime=e.timer,o.bestScore=e.timer)}),v(t?"Porte franchie":"Temps écoulé",(a==null?void 0:a.uiText.help)||"")}function v(t,f,o=!0){d.style.display="grid",d.innerHTML=`
    <div class="panel">
      <p class="pill">Mini Quest</p>
      <h2>${t}</h2>
      <p>${f}</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        ${o?'<button class="btn" id="play-btn">Lancer</button>':""}
        <a class="btn secondary" href="${M("/apps/hub/")}">Hub</a>
      </div>
    </div>
  `;const l=document.getElementById("play-btn");l==null||l.addEventListener("click",$)}v((a==null?void 0:a.uiText.title)||"Mini Quest",(a==null?void 0:a.uiText.help)||"");function O(t){if(!e.running||!a)return;if(e.timer-=t,e.timer<=0){E(!1);return}const f=(u.isDown(n.right)?1:0)+(u.isDown(n.left)?-1:0),o=(u.isDown(n.down)?1:0)+(u.isDown(n.up)?-1:0);e.player.x+=f*a.difficultyParams.playerSpeed*(t*60),e.player.y+=o*a.difficultyParams.playerSpeed*(t*60),e.player.x=P(e.player.x,e.player.r,e.width-e.player.r),e.player.y=P(e.player.y,e.player.r,e.height-e.player.r),e.items.forEach(s=>{if(s.collected)return;const p=s.x-e.player.x,y=s.y-e.player.y;Math.sqrt(p*p+y*y)<e.player.r+10&&(s.collected=!0,e.collected+=1,h({type:"ITEM_COLLECTED",gameId:c}),e.collected>=e.items.length&&(e.gate.open=!0,h({type:"GATE_UNLOCKED",gameId:c})))}),e.traps.forEach(s=>{if(!s.active)return;const p=s.x-e.player.x,y=s.y-e.player.y;Math.sqrt(p*p+y*y)<e.player.r+10&&(s.active=!1,e.timer=Math.max(0,e.timer-5),h({type:"TRAP_TRIGGERED",gameId:c}))});const l=e.gate.x-e.player.x,w=e.gate.y-e.player.y;e.gate.open&&Math.sqrt(l*l+w*w)<e.player.r+16&&E(!0)}function _(){r.save(),r.scale(devicePixelRatio,devicePixelRatio),r.clearRect(0,0,e.width,e.height),r.fillStyle=e.gate.open?i.colors.accent:"rgba(255,255,255,0.1)",r.fillRect(e.gate.x-14,e.gate.y-24,28,48),e.items.forEach(t=>{r.fillStyle=t.collected?"rgba(255,255,255,0.2)":i.colors.secondary,r.beginPath(),r.arc(t.x,t.y,10,0,Math.PI*2),r.fill()}),r.fillStyle="rgba(255,95,109,0.9)",e.traps.forEach(t=>{t.active&&(r.beginPath(),r.moveTo(t.x,t.y-10),r.lineTo(t.x-10,t.y+10),r.lineTo(t.x+10,t.y+10),r.closePath(),r.fill())}),r.fillStyle=i.colors.primary,r.beginPath(),r.arc(e.player.x,e.player.y,e.player.r,0,Math.PI*2),r.fill(),r.restore(),q()}function q(){x.innerHTML="",x.appendChild(d);const t=document.createElement("div");t.className="hud",t.innerHTML=`
    <div class="pill">Temps ${e.timer.toFixed(1)}s</div>
    <div class="pill">Objets ${e.collected}/${e.items.length}</div>
    <div class="pill">Porte ${e.gate.open?"ouverte":"fermée"}</div>
  `,x.appendChild(t)}
