import{d as I,c as S,w as L,r as g,e as w}from"./loaders-C6hX0A3C.js";import{c as M,a as R}from"./loop-H9o27inI.js";import{b as C,e as m,d as G}from"./index-DEUwev7d.js";const o="quest",a=I(o),P=S(),r=P.find(t=>t.id===(a==null?void 0:a.themeId))||P[0];C();if(r){const t=document.documentElement.style;t.setProperty("--color-primary",r.colors.primary),t.setProperty("--color-secondary",r.colors.secondary),t.setProperty("--color-accent",r.colors.accent),t.setProperty("--color-text",r.colors.text),t.setProperty("--color-muted",r.colors.muted),document.body.style.background=r.gradient||document.body.style.background}const p=document.getElementById("game-canvas"),f=document.getElementById("ui"),i=p.getContext("2d"),h=M(),c=document.createElement("div");c.className="overlay";c.style.display="none";f.appendChild(c);const e={running:!1,width:0,height:0,player:{x:0,y:0,r:12},items:[],traps:[],gate:{x:0,y:0,open:!1},timer:(a==null?void 0:a.difficultyParams.timeLimitSeconds)??60,collected:0};function E(){p.width=window.innerWidth*devicePixelRatio,p.height=window.innerHeight*devicePixelRatio,e.width=p.width/devicePixelRatio,e.height=p.height/devicePixelRatio}E();window.addEventListener("resize",E);const T=R({update:t=>$(t),render:O,fps:60});function A(){if(!a){x("Config manquante","Ajoute configs/games/quest.config.json",!1);return}e.running=!0,e.player.x=e.width*.15,e.player.y=e.height/2,e.items=[],e.traps=[],e.collected=0,e.gate={x:e.width*.85,y:e.height/2,open:!1},e.timer=a.difficultyParams.timeLimitSeconds,D(),k(),c.style.display="none",m({type:"SESSION_START",gameId:o}),T.start()}function D(){for(let t=0;t<((a==null?void 0:a.difficultyParams.itemCount)??6);t++)e.items.push({x:g(e.width*.25,e.width*.8),y:g(50,e.height-50),collected:!1})}function k(){for(let t=0;t<((a==null?void 0:a.difficultyParams.trapCount)??4);t++)e.traps.push({x:g(e.width*.2,e.width*.8),y:g(60,e.height-60),active:!0})}function b(t){e.running=!1,T.stop(),m({type:t?"QUEST_COMPLETE":"SESSION_FAIL",gameId:o,payload:{remaining:e.timer}}),G(o,(a==null?void 0:a.saveSchemaVersion)??1,l=>{const n=l.state.bestTime||0;t&&e.timer>n&&(l.state.bestTime=e.timer,l.bestScore=e.timer)}),x(t?"Porte franchie":"Temps écoulé",(a==null?void 0:a.uiText.help)||"")}function x(t,u,l=!0){c.style.display="grid",c.innerHTML=`
    <div class="panel">
      <p class="pill">Mini Quest</p>
      <h2>${t}</h2>
      <p>${u}</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        ${l?'<button class="btn" id="play-btn">Lancer</button>':""}
        <a class="btn secondary" href="${L("/apps/hub/")}">Hub</a>
      </div>
    </div>
  `;const n=document.getElementById("play-btn");n==null||n.addEventListener("click",A)}x((a==null?void 0:a.uiText.title)||"Mini Quest",(a==null?void 0:a.uiText.help)||"");function $(t){if(!e.running||!a)return;if(e.timer-=t,e.timer<=0){b(!1);return}const u=(h.isDown(a.input.keys.right||"ArrowRight")?1:0)+(h.isDown(a.input.keys.left||"ArrowLeft")?-1:0),l=(h.isDown(a.input.keys.down||"ArrowDown")?1:0)+(h.isDown(a.input.keys.up||"ArrowUp")?-1:0);e.player.x+=u*a.difficultyParams.playerSpeed*(t*60),e.player.y+=l*a.difficultyParams.playerSpeed*(t*60),e.player.x=w(e.player.x,e.player.r,e.width-e.player.r),e.player.y=w(e.player.y,e.player.r,e.height-e.player.r),e.items.forEach(s=>{if(s.collected)return;const d=s.x-e.player.x,y=s.y-e.player.y;Math.sqrt(d*d+y*y)<e.player.r+10&&(s.collected=!0,e.collected+=1,m({type:"ITEM_COLLECTED",gameId:o}),e.collected>=e.items.length&&(e.gate.open=!0,m({type:"GATE_UNLOCKED",gameId:o})))}),e.traps.forEach(s=>{if(!s.active)return;const d=s.x-e.player.x,y=s.y-e.player.y;Math.sqrt(d*d+y*y)<e.player.r+10&&(s.active=!1,e.timer=Math.max(0,e.timer-5),m({type:"TRAP_TRIGGERED",gameId:o}))});const n=e.gate.x-e.player.x,v=e.gate.y-e.player.y;e.gate.open&&Math.sqrt(n*n+v*v)<e.player.r+16&&b(!0)}function O(){i.save(),i.scale(devicePixelRatio,devicePixelRatio),i.clearRect(0,0,e.width,e.height),i.fillStyle=e.gate.open?r.colors.accent:"rgba(255,255,255,0.1)",i.fillRect(e.gate.x-14,e.gate.y-24,28,48),e.items.forEach(t=>{i.fillStyle=t.collected?"rgba(255,255,255,0.2)":r.colors.secondary,i.beginPath(),i.arc(t.x,t.y,10,0,Math.PI*2),i.fill()}),i.fillStyle="rgba(255,95,109,0.9)",e.traps.forEach(t=>{t.active&&(i.beginPath(),i.moveTo(t.x,t.y-10),i.lineTo(t.x-10,t.y+10),i.lineTo(t.x+10,t.y+10),i.closePath(),i.fill())}),i.fillStyle=r.colors.primary,i.beginPath(),i.arc(e.player.x,e.player.y,e.player.r,0,Math.PI*2),i.fill(),i.restore(),_()}function _(){f.innerHTML="",f.appendChild(c);const t=document.createElement("div");t.className="hud",t.innerHTML=`
    <div class="pill">Temps ${e.timer.toFixed(1)}s</div>
    <div class="pill">Objets ${e.collected}/${e.items.length}</div>
    <div class="pill">Porte ${e.gate.open?"ouverte":"fermée"}</div>
  `,f.appendChild(t)}
