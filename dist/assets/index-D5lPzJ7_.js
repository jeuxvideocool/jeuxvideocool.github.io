var w=Object.defineProperty;var V=(t,e,s)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var E=(t,e,s)=>V(t,typeof e!="symbol"?e+"":e,s);import{o as f,n as r,h as m,i as G,j as X,s as c,b as R,g as _,k as q,m as U,p as J,e as B,d as j}from"./loaders-Bj0CnEmo.js";class D{constructor(){E(this,"listeners",{})}on(e,s){return this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(s),()=>this.off(e,s)}off(e,s){this.listeners[e]=(this.listeners[e]||[]).filter(a=>a!==s)}emit(e){const s={timestamp:Date.now(),...e};(this.listeners[e.type]||[]).forEach(o=>o(s)),(this.listeners["*"]||[]).forEach(o=>o(s))}}const y=new D;function F(t){y.emit(t)}function z(t,e){return t==="*"?y.on("*",e):y.on(t,e)}const d=3,x="nintendo-hub-save",H=f({saveSchemaVersion:r().int().default(1),state:m(G()).default({}),lastPlayedAt:r().optional(),bestScore:r().optional(),timePlayedMs:r().default(0),sessionStartedAt:r().optional()}),k=f({schemaVersion:r().int().default(d),playerProfile:f({name:c(),avatar:c(),lastPlayedGameId:c().optional()}).default({name:"Joueur",avatar:"ðŸŽ®"}),globalXP:r().default(0),globalLevel:r().default(1),achievementsUnlocked:X(c()).default([]),globalStats:f({events:m(r()).default({}),gamesPlayed:r().default(0),totalSessions:r().default(0),streaks:m(r()).default({}),timePlayedMs:r().default(0),currentSessionStartedAt:r().optional()}).default({events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0}),favorites:X(c()).default([]),games:m(H).default({})});function h(){return{schemaVersion:d,playerProfile:{name:"Joueur",avatar:"ðŸŽ®"},globalXP:0,globalLevel:1,achievementsUnlocked:[],globalStats:{events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0},favorites:[],games:{}}}function I(t){let e={...t};return(!e.schemaVersion||e.schemaVersion<1)&&(e.schemaVersion=1),e.schemaVersion<2&&(e.globalStats.timePlayedMs=e.globalStats.timePlayedMs??0,e.globalStats.currentSessionStartedAt=void 0,Object.values(e.games||{}).forEach(s=>{s.timePlayedMs=s.timePlayedMs??0,s.sessionStartedAt=void 0}),e.schemaVersion=2),e.schemaVersion<3&&(e.favorites=Array.isArray(e.favorites)?Array.from(new Set(e.favorites.filter(s=>typeof s=="string"))):[],e.schemaVersion=3),e.schemaVersion<d&&(e.schemaVersion=d),e}function P(){try{const t=localStorage.getItem(x);if(!t)return h();const e=JSON.parse(t),s=k.parse(e);return I(s)}catch(t){return console.warn("Corrupt save detected, resetting.",t),h()}}function g(t){const e={...t,schemaVersion:d};localStorage.setItem(x,JSON.stringify(e)),K(e)}function v(t){const e=P();return t(e),g(e),e}function ne(){const t=P();return JSON.stringify(t,null,2)}function oe(t){try{const e=JSON.parse(t),s=k.parse(e),a=I(s);return g(a),{success:!0,state:a}}catch(e){return{success:!1,error:(e==null?void 0:e.message)||"Import invalide"}}}function re(){const t=h();return g(t),t}function ie(t){return v(e=>{delete e.games[t]})}function b(t,e,s=1){return t.games[e]||(t.games[e]={saveSchemaVersion:s,state:{},timePlayedMs:0}),t.games[e]}function M(t,e){t.playerProfile.lastPlayedGameId=e;const s=b(t,e);s.lastPlayedAt=Date.now()}function le(t,e,s){return v(a=>{const n=b(a,t,e);n.saveSchemaVersion=e,s(n),M(a,t)})}const S=[];function K(t){S.forEach(e=>e(t))}function ce(t){return S.push(t),()=>{const e=S.indexOf(t);e>=0&&S.splice(e,1)}}const l={xpConfig:J(),rewardsConfig:U(),achievements:q(),registry:_(),gameConfigs:R()},p={achievementId:"alex-birthday-31",minXP:31e3,requiredName:"alex"};function W(t){return l.gameConfigs.find(e=>e.id===t)||j(t)}function Y(t){var s;const e=t.gameId?W(t.gameId):void 0;return((s=e==null?void 0:e.xpRules)==null?void 0:s[t.type])!==void 0?e.xpRules[t.type]:l.rewardsConfig.defaults[t.type]??0}function C(t,e){var A;const s=[...e.levels].sort((i,O)=>i.requiredXP-O.requiredXP);let a=1,n=s[s.length-1].requiredXP;for(let i=0;i<s.length;i++)t>=s[i].requiredXP&&(a=s[i].level,n=s[Math.min(s.length-1,i+1)].requiredXP);const o=((A=s.find(i=>i.level===a))==null?void 0:A.requiredXP)??0,u=Math.max(n-o,1),T=B((t-o)/u,0,1);return{level:a,nextLevelXP:n,currentLevelXP:o,levelProgress:T}}function Q(t,e){var n;const s=e.condition,a=(n=t.playerProfile.name)==null?void 0:n.trim().toLowerCase();return s.type==="eventCount"?(t.globalStats.events[s.event]??0)>=s.count:s.type==="xpReached"?t.globalXP>=s.xp:s.type==="gamesPlayed"?Object.keys(t.games).length>=s.count:s.type==="streak"?(t.globalStats.streaks[s.event]??0)>=s.count:s.type==="playerXpName"?t.globalXP>=s.xp&&a===s.name.trim().toLowerCase():!1}function L(t,e){e.forEach(s=>{if(t.achievementsUnlocked.includes(s.id))return;Q(t,s)&&(t.achievementsUnlocked.push(s.id),s.rewardXP&&(t.globalXP+=s.rewardXP),F({type:"ACHIEVEMENT_UNLOCKED",payload:{achievementId:s.id}}))})}function de(t){var a;const e=(a=t.playerProfile.name)==null?void 0:a.trim().toLowerCase();return t.achievementsUnlocked.includes(p.achievementId)&&t.globalXP>=p.minXP&&e===p.requiredName}function Z(t,e){t.globalStats.streaks[e.type]||(t.globalStats.streaks[e.type]=0),t.globalStats.streaks[e.type]+=1,e.type==="SESSION_FAIL"&&(t.globalStats.streaks.SESSION_WIN=0)}function $(t,e,s){const a=e.timestamp??Date.now();if(e.type==="SESSION_START"){if(t.globalStats.currentSessionStartedAt=a,s){if(s.sessionStartedAt&&s.sessionStartedAt<a){const n=a-s.sessionStartedAt;s.timePlayedMs=(s.timePlayedMs??0)+Math.max(0,n),t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+Math.max(0,n)}s.sessionStartedAt=a}return}if(e.type==="SESSION_WIN"||e.type==="SESSION_FAIL"){const n=(s==null?void 0:s.sessionStartedAt)??t.globalStats.currentSessionStartedAt,o=n?Math.max(0,a-n):0;t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+o,s&&(s.timePlayedMs=(s.timePlayedMs??0)+o,s.sessionStartedAt=void 0),t.globalStats.currentSessionStartedAt=void 0}}function ee(t,e){var a;const s=Y(e);if(s>0&&(t.globalXP+=s),t.globalStats.events[e.type]||(t.globalStats.events[e.type]=0),t.globalStats.events[e.type]+=1,t.globalStats.totalSessions+=e.type==="SESSION_START"?1:0,Z(t,e),e.gameId){const n=!!t.games[e.gameId],o=b(t,e.gameId);if($(t,e,o),e.type==="SESSION_START"&&(t.globalStats.gamesPlayed+=n?0:1),M(t,e.gameId),((a=e.payload)==null?void 0:a.score)!==void 0){const u=Number(e.payload.score);(!o.bestScore||u>o.bestScore)&&(o.bestScore=u)}}}function N(t){const{level:e}=C(t.globalXP,l.xpConfig);t.globalLevel=e}function te(t){return v(s=>{ee(s,t),L(s,l.achievements),N(s)})}function ue(){z("*",t=>{te(t)})}function fe(){const t=P();L(t,l.achievements),N(t);const{levelProgress:e,currentLevelXP:s,nextLevelXP:a}=C(t.globalXP,l.xpConfig),n={save:t,levelProgress:e,currentLevelXP:s,nextLevelXP:a};return g(t),n}export{p as A,ue as a,re as b,de as c,F as d,ne as e,le as f,fe as g,oe as i,P as l,z as o,ie as r,ce as s,v as u};
