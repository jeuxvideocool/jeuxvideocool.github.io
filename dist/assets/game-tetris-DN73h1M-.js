import{d as H,c as M,e as R,w as D}from"./loaders-Bj0CnEmo.js";import{c as W,a as $}from"./input-CrBvr0XE.js";import{c as N}from"./loop-24SuRqx9.js";import{a as O,d as b,f as U}from"./index-D5lPzJ7_.js";const j="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%237CFFE1'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%237CFFE1'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",z="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%237B8CFF'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%237B8CFF'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",K="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%23FF7EE2'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%23FF7EE2'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",V="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%23FFC36A'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%23FFC36A'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",X="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%237AF0FF'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%237AF0FF'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",Y="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%237CFFA5'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%237CFFA5'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",q="data:image/svg+xml,%3csvg%20width='64'%20height='64'%20viewBox='0%200%2064%2064'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3crect%20x='4'%20y='4'%20width='56'%20height='56'%20rx='10'%20fill='url(%23g)'%20stroke='%23A987FF'%20stroke-width='4'/%3e%3cdefs%3e%3clinearGradient%20id='g'%20x1='0'%20y1='0'%20x2='1'%20y2='1'%3e%3cstop%20stop-color='%23A987FF'/%3e%3cstop%20offset='1'%20stop-color='%230E1B2F'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e",y="tetris",o=H(y),_=M(),h=o&&_.find(t=>t.id===o.themeId)||_[0];O();const J=Array.from({length:8},(t,i)=>{if(i===0)return null;const r=new Image;return r.src=new URL(Object.assign({"../assets/block1.svg":j,"../assets/block2.svg":z,"../assets/block3.svg":K,"../assets/block4.svg":V,"../assets/block5.svg":X,"../assets/block6.svg":Y,"../assets/block7.svg":q})[`../assets/block${i}.svg`],import.meta.url).href,r});if(h){const t=document.documentElement.style;t.setProperty("--color-primary",h.colors.primary),t.setProperty("--color-secondary",h.colors.secondary),t.setProperty("--color-accent",h.colors.accent),t.setProperty("--color-text",h.colors.text),t.setProperty("--color-muted",h.colors.muted),document.body.style.background=h.gradient||document.body.style.background}const m=document.getElementById("game-canvas"),x=document.getElementById("ui"),l=m.getContext("2d"),g=W(),f=document.createElement("div");f.className="overlay";f.style.display="none";x.appendChild(f);const P=[[[1,1,1,1],[0,0,0,0],[0,0,0,0],[0,0,0,0]],[[2,2],[2,2]],[[0,3,0],[3,3,3],[0,0,0]],[[4,0,0],[4,4,4],[0,0,0]],[[0,0,5],[5,5,5],[0,0,0]],[[0,6,6],[6,6,0],[0,0,0]],[[7,7,0],[0,7,7],[0,0,0]]],e={running:!1,width:0,height:0,cell:24,boardWidth:(o==null?void 0:o.difficultyParams.boardWidth)??10,boardHeight:(o==null?void 0:o.difficultyParams.boardHeight)??20,board:[],current:null,next:null,dropTimer:0,dropInterval:(o==null?void 0:o.difficultyParams.dropIntervalMs)??800,baseDropInterval:(o==null?void 0:o.difficultyParams.dropIntervalMs)??800,speedUpFactor:(o==null?void 0:o.difficultyParams.speedUpFactor)??.92,lines:0,level:1,score:0,targetLines:(o==null?void 0:o.difficultyParams.linesToWin)??24},c={left:(o==null?void 0:o.input.keys.left)||"ArrowLeft",right:(o==null?void 0:o.input.keys.right)||"ArrowRight",down:(o==null?void 0:o.input.keys.down)||"ArrowDown",rotate:(o==null?void 0:o.input.keys.rotate)||"ArrowUp",drop:(o==null?void 0:o.input.keys.drop)||"Space"},F=$({container:document.body,input:g,mapping:{left:c.left,right:c.right,down:c.down,up:c.rotate,actionA:c.rotate,actionALabel:"Rotate",actionB:c.drop,actionBLabel:"Drop"},autoShow:!1,showPad:!1}),d={};function A(){m.width=window.innerWidth*devicePixelRatio,m.height=window.innerHeight*devicePixelRatio,e.width=m.width/devicePixelRatio,e.height=m.height/devicePixelRatio;const t=Math.floor(e.width/(e.boardWidth+6)),i=Math.floor(e.height/(e.boardHeight+2));e.cell=R(Math.min(t,i),18,36)}A();window.addEventListener("resize",A);const L=N({update:t=>se(t),render:le,fps:60});function Q(){e.board=Array.from({length:e.boardHeight},()=>Array(e.boardWidth).fill(0))}function k(){const t=Math.floor(Math.random()*P.length);return{matrix:P[t].map(i=>[...i]),x:Math.floor(e.boardWidth/2)-2,y:0,id:t}}function Z(t){const i=t.length,r=Array.from({length:i},()=>Array(i).fill(0));for(let n=0;n<i;n++)for(let s=0;s<i;s++)r[s][i-1-n]=t[n][s];return r}function v(t,i,r){const n=t.matrix;for(let s=0;s<n.length;s++)for(let a=0;a<n[s].length;a++){if(!n[s][a])continue;const p=t.x+a+i,u=t.y+s+r;if(p<0||p>=e.boardWidth||u>=e.boardHeight||u>=0&&e.board[u][p])return!0}return!1}function E(){e.current=e.next??k(),e.current.x=Math.floor(e.boardWidth/2)-2,e.current.y=-1,e.next=k(),v(e.current,0,0)&&G(!1)}function S(){if(!e.current)return;const t=e.current.matrix;for(let i=0;i<t.length;i++)for(let r=0;r<t[i].length;r++){if(!t[i][r])continue;const n=e.current.x+r,s=e.current.y+i;s>=0&&s<e.boardHeight&&n>=0&&n<e.boardWidth&&(e.board[s][n]=t[i][r])}}function C(){const t=[];for(let r=e.boardHeight-1;r>=0;r--)e.board[r].every(n=>n!==0)&&t.push(r);if(!t.length)return;for(t.forEach(r=>e.board.splice(r,1));e.board.length<e.boardHeight;)e.board.unshift(Array(e.boardWidth).fill(0));e.lines+=t.length;const i=[0,100,300,500,800];e.score+=(i[t.length]||1e3)*e.level;for(let r=0;r<t.length;r++)b({type:"LINES_CLEARED",gameId:y});t.length===4&&b({type:"TETRIS_CLEAR",gameId:y,payload:{lines:4}}),e.level=1+Math.floor(e.lines/10),e.dropInterval=e.baseDropInterval*Math.pow(e.speedUpFactor,e.level-1),e.lines>=e.targetLines&&G(!0)}function ee(){if(!e.current)return;let t=0;for(;!v(e.current,0,t+1);)t++;e.current.y+=t,S(),C(),E()}function B(t){!e.current||v(e.current,t,0)||(e.current.x+=t)}function te(){if(!e.current)return;const t=Z(e.current.matrix),i=[[0,0],[1,0],[-1,0],[0,-1]];for(const[r,n]of i){const s={...e.current,matrix:t,x:e.current.x+r,y:e.current.y+n};if(!v(s,0,0)){e.current.matrix=t,e.current.x=s.x,e.current.y=s.y;return}}}function re(t){e.dropTimer+=t*1e3*3}function oe(t){e.dropTimer+=t*1e3,!(e.dropTimer<e.dropInterval)&&(e.dropTimer=0,e.current&&(v(e.current,0,1)?(S(),C(),E()):e.current.y+=1))}function ie(){if(!o){I("Config à compléter","Crée configs/games/tetris.config.json",!1);return}F.show(),e.running=!0,e.lines=0,e.level=1,e.score=0,e.dropInterval=e.baseDropInterval,e.dropTimer=0,e.current=null,e.next=k(),Q(),E(),f.style.display="none",b({type:"SESSION_START",gameId:y}),L.start()}function G(t){e.running=!1,L.stop(),F.hide(),b({type:t?"SESSION_WIN":"SESSION_FAIL",gameId:y,payload:{score:e.score,lines:e.lines}}),o&&U(y,o.saveSchemaVersion,r=>{const n=r.state.bestLines||0;e.lines>n&&(r.state.bestLines=e.lines,r.bestScore=e.lines)}),I(t?"GG, objectif atteint !":"Pile trop haute !",(o==null?void 0:o.uiText.help)||"Rejoue pour battre ton record.")}function ne(t){const i=g.isDown(c.left),r=g.isDown(c.right),n=g.isDown(c.rotate),s=g.isDown(c.drop),a=g.isDown(c.down);i&&!d.left&&B(-1),r&&!d.right&&B(1),n&&!d.rotate&&te(),s&&!d.drop&&ee(),a&&re(t),d.left=i,d.right=r,d.rotate=n,d.drop=s}function se(t){!e.running||!o||(ne(t),oe(t))}function le(){l.save(),l.scale(devicePixelRatio,devicePixelRatio),l.clearRect(0,0,e.width,e.height),l.fillStyle="rgba(255,255,255,0.03)",l.fillRect(0,0,e.width,e.height);const t=(e.width-e.boardWidth*e.cell)/2,i=(e.height-e.boardHeight*e.cell)/2;l.strokeStyle="rgba(255,255,255,0.08)";for(let r=0;r<=e.boardWidth;r++)l.beginPath(),l.moveTo(t+r*e.cell,i),l.lineTo(t+r*e.cell,i+e.boardHeight*e.cell),l.stroke();for(let r=0;r<=e.boardHeight;r++)l.beginPath(),l.moveTo(t,i+r*e.cell),l.lineTo(t+e.boardWidth*e.cell,i+r*e.cell),l.stroke();for(let r=0;r<e.boardHeight;r++)for(let n=0;n<e.boardWidth;n++){const s=e.board[r][n];s&&T(n,r,s,t,i)}if(e.current){const r=e.current.matrix;for(let n=0;n<r.length;n++)for(let s=0;s<r[n].length;s++){if(!r[n][s])continue;const a=r[n][s];T(e.current.x+s,e.current.y+n,a,t,i,!0)}}l.restore(),ce()}function T(t,i,r,n,s,a=!1){const p=n+t*e.cell,u=s+i*e.cell,w=J[r];w!=null&&w.complete?l.drawImage(w,p+1,u+1,e.cell-2,e.cell-2):(l.fillStyle=h.colors.primary,l.fillRect(p+1,u+1,e.cell-2,e.cell-2)),l.strokeStyle=a?"rgba(255,255,255,0.6)":"rgba(255,255,255,0.2)",l.strokeRect(p+.5,u+.5,e.cell-1,e.cell-1)}function ce(){x.innerHTML="",x.appendChild(f);const t=document.createElement("div");t.className="hud",t.innerHTML=`
    <div class="pill">Lignes ${e.lines}/${e.targetLines}</div>
    <div class="pill">Niveau ${e.level}</div>
    <div class="pill">Score ${e.score}</div>
  `,x.appendChild(t)}function I(t,i,r=!0){F.hide(),f.style.display="grid",f.innerHTML=`
    <div class="panel">
      <p class="pill">Tetris Mini</p>
      <h2>${t}</h2>
      <p>${i}</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        ${r?'<button class="btn" id="play-btn">Lancer</button>':""}
        <a class="btn secondary" href="${D("/apps/hub/")}">Hub</a>
      </div>
      <p class="legend">Contrôles : Gauche/Droite pour bouger · Haut pour rotate · Bas pour descendre · Espace pour drop instantané.</p>
    </div>
  `;const n=document.getElementById("play-btn");n==null||n.addEventListener("click",ie)}I((o==null?void 0:o.uiText.title)||"Tetris Mini",(o==null?void 0:o.uiText.help)||"");
