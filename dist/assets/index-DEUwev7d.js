var N=Object.defineProperty;var L=(t,e,s)=>e in t?N(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var v=(t,e,s)=>L(t,typeof e!="symbol"?e+"":e,s);import{o as f,n as r,h as S,i as O,j as T,s as u,b as w,g as G,k as V,l as R,m as _,e as q,d as J}from"./loaders-C6hX0A3C.js";class U{constructor(){v(this,"listeners",{})}on(e,s){return this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(s),()=>this.off(e,s)}off(e,s){this.listeners[e]=(this.listeners[e]||[]).filter(a=>a!==s)}emit(e){const s={timestamp:Date.now(),...e};(this.listeners[e.type]||[]).forEach(n=>n(s)),(this.listeners["*"]||[]).forEach(n=>n(s))}}const m=new U;function j(t){m.emit(t)}function B(t,e){return t==="*"?m.on("*",e):m.on(t,e)}const c=2,E="nintendo-hub-save",D=f({saveSchemaVersion:r().int().default(1),state:S(O()).default({}),lastPlayedAt:r().optional(),bestScore:r().optional(),timePlayedMs:r().default(0),sessionStartedAt:r().optional()}),A=f({schemaVersion:r().int().default(c),playerProfile:f({name:u(),avatar:u(),lastPlayedGameId:u().optional()}).default({name:"Joueur",avatar:"ðŸŽ®"}),globalXP:r().default(0),globalLevel:r().default(1),achievementsUnlocked:T(u()).default([]),globalStats:f({events:S(r()).default({}),gamesPlayed:r().default(0),totalSessions:r().default(0),streaks:S(r()).default({}),timePlayedMs:r().default(0),currentSessionStartedAt:r().optional()}).default({events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0}),games:S(D).default({})});function p(){return{schemaVersion:c,playerProfile:{name:"Joueur",avatar:"ðŸŽ®"},globalXP:0,globalLevel:1,achievementsUnlocked:[],globalStats:{events:{},gamesPlayed:0,totalSessions:0,streaks:{},timePlayedMs:0},games:{}}}function M(t){let e={...t};return(!e.schemaVersion||e.schemaVersion<1)&&(e.schemaVersion=1),e.schemaVersion<2&&(e.globalStats.timePlayedMs=e.globalStats.timePlayedMs??0,e.globalStats.currentSessionStartedAt=void 0,Object.values(e.games||{}).forEach(s=>{s.timePlayedMs=s.timePlayedMs??0,s.sessionStartedAt=void 0}),e.schemaVersion=2),e.schemaVersion<c&&(e.schemaVersion=c),e}function y(){try{const t=localStorage.getItem(E);if(!t)return p();const e=JSON.parse(t),s=A.parse(e);return M(s)}catch(t){return console.warn("Corrupt save detected, resetting.",t),p()}}function g(t){const e={...t,schemaVersion:c};localStorage.setItem(E,JSON.stringify(e))}function P(t){const e=y();return t(e),g(e),e}function ee(){const t=y();return JSON.stringify(t,null,2)}function te(t){try{const e=JSON.parse(t),s=A.parse(e),a=M(s);return g(a),{success:!0,state:a}}catch(e){return{success:!1,error:(e==null?void 0:e.message)||"Import invalide"}}}function se(){const t=p();return g(t),t}function ae(t){return P(e=>{delete e.games[t]})}function h(t,e,s=1){return t.games[e]||(t.games[e]={saveSchemaVersion:s,state:{},timePlayedMs:0}),t.games[e]}function I(t,e){t.playerProfile.lastPlayedGameId=e;const s=h(t,e);s.lastPlayedAt=Date.now()}function oe(t,e,s){return P(a=>{const o=h(a,t,e);o.saveSchemaVersion=e,s(o),I(a,t)})}const d={xpConfig:_(),rewardsConfig:R(),achievements:V(),registry:G(),gameConfigs:w()};function F(t){return d.gameConfigs.find(e=>e.id===t)||J(t)}function H(t){var s;const e=t.gameId?F(t.gameId):void 0;return((s=e==null?void 0:e.xpRules)==null?void 0:s[t.type])!==void 0?e.xpRules[t.type]:d.rewardsConfig.defaults[t.type]??0}function X(t,e){var b;const s=[...e.levels].sort((l,C)=>l.requiredXP-C.requiredXP);let a=1,o=s[s.length-1].requiredXP;for(let l=0;l<s.length;l++)t>=s[l].requiredXP&&(a=s[l].level,o=s[Math.min(s.length-1,l+1)].requiredXP);const n=((b=s.find(l=>l.level===a))==null?void 0:b.requiredXP)??0,i=Math.max(o-n,1),x=q((t-n)/i,0,1);return{level:a,nextLevelXP:o,currentLevelXP:n,levelProgress:x}}function K(t,e,s){s.forEach(a=>{if(t.achievementsUnlocked.includes(a.id))return;const o=a.condition;let n=!1;o.type==="eventCount"?n=(t.globalStats.events[o.event]??0)>=o.count:o.type==="xpReached"?n=t.globalXP>=o.xp:o.type==="gamesPlayed"?n=Object.keys(t.games).length>=o.count:o.type==="streak"&&(n=(t.globalStats.streaks[o.event]??0)>=o.count),n&&(t.achievementsUnlocked.push(a.id),a.rewardXP&&(t.globalXP+=a.rewardXP),j({type:"ACHIEVEMENT_UNLOCKED",payload:{achievementId:a.id}}))})}function W(t,e){t.globalStats.streaks[e.type]||(t.globalStats.streaks[e.type]=0),t.globalStats.streaks[e.type]+=1,e.type==="SESSION_FAIL"&&(t.globalStats.streaks.SESSION_WIN=0)}function Y(t,e,s){const a=e.timestamp??Date.now();if(e.type==="SESSION_START"){if(t.globalStats.currentSessionStartedAt=a,s){if(s.sessionStartedAt&&s.sessionStartedAt<a){const o=a-s.sessionStartedAt;s.timePlayedMs=(s.timePlayedMs??0)+Math.max(0,o),t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+Math.max(0,o)}s.sessionStartedAt=a}return}if(e.type==="SESSION_WIN"||e.type==="SESSION_FAIL"){const o=(s==null?void 0:s.sessionStartedAt)??t.globalStats.currentSessionStartedAt,n=o?Math.max(0,a-o):0;t.globalStats.timePlayedMs=(t.globalStats.timePlayedMs??0)+n,s&&(s.timePlayedMs=(s.timePlayedMs??0)+n,s.sessionStartedAt=void 0),t.globalStats.currentSessionStartedAt=void 0}}function z(t,e){var a;const s=H(e);if(s>0&&(t.globalXP+=s),t.globalStats.events[e.type]||(t.globalStats.events[e.type]=0),t.globalStats.events[e.type]+=1,t.globalStats.totalSessions+=e.type==="SESSION_START"?1:0,W(t,e),e.gameId){const o=!!t.games[e.gameId],n=h(t,e.gameId);if(Y(t,e,n),e.type==="SESSION_START"&&(t.globalStats.gamesPlayed+=o?0:1),I(t,e.gameId),((a=e.payload)==null?void 0:a.score)!==void 0){const i=Number(e.payload.score);(!n.bestScore||i>n.bestScore)&&(n.bestScore=i)}}}function k(t){const{level:e}=X(t.globalXP,d.xpConfig);t.globalLevel=e}function Q(t){return P(s=>{z(s,t),K(s,t,d.achievements),k(s)})}function ne(){B("*",t=>{Q(t)})}function re(){const t=y();k(t);const{levelProgress:e,currentLevelXP:s,nextLevelXP:a}=X(t.globalXP,d.xpConfig),o={save:t,levelProgress:e,currentLevelXP:s,nextLevelXP:a};return g(t),o}export{ee as a,ne as b,ae as c,oe as d,j as e,re as g,te as i,B as o,se as r,P as u};
